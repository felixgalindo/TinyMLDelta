# TinyMLDelta

TinyMLDelta is an **incremental model-update system** for TinyML and embedded AI devices.

Instead of shipping an entire TensorFlow Lite Micro model (often **20â€“200+ KB**),
you ship a **small binary patch** that mutates the existing model in flash into a new one.

This reduces:

- OTA bandwidth  
- Cellular / satellite data costs  
- Flash wear  
- Update latency  
- Fleet fragmentation  
- Bootloader complexity  

TinyMLDelta performs **safe, atomic, guardrail-checked updates** on
extremely low-resource MCUs.

------------------------------------------------------------------------

## Supported Today

- TensorFlow Lite Micro  
- POSIX/macOS simulated flash environment  
- CRC32 integrity checking  
- A/B slot updates  
- Crash-safe journaling  

## Planned

- Edge Impulse frontend  
- SHA-256 and AES-CMAC signatures  
- Model versioning  
- Vendor metadata  
- MCU integrations (Zephyr, Arduino UNO R4 WiFi, Tachyon)

------------------------------------------------------------------------

## Patch vs Firmware Update --- What Requires What?

TinyMLDelta can safely update models **only when the firmware remains
compatible** with the new model.
Compatibility is enforced using **metadata TLVs** generated by PatchGen
and validated by the MCU runtime.

### âœ” Patch-friendly changes (safe, incremental)

No firmware update required:

-   Weight updates
-   Bias updates
-   Quantization parameter changes
-   Re-training the same architecture
-   Minor graph edits without operator changes
-   Same opset, same ABI, same I/O schema
-   Similar tensor shapes
-   Same input/output dtypes

These produce compact patches.

## âŒ Changes requiring a full firmware update

| Change Type | Firmware Update Required? | Why |
|------------|---------------------------|-----|
| **New operators** | âœ” Yes | Firmware must link kernels |
| **Opset version changes** | âœ” Yes | Operator implementations differ |
| **TFLM ABI changes** | âœ” Yes | Interpreter ABI mismatch |
| **Arena requirement > compiled arena** | âœ” Yes | Arena lives in static `.bss`; fixed at build |
| **Tensor I/O schema changes** | âœ” Yes | Application code relies on shapes/dtypes |
| **Flex ops / newer TFLite schema** | âœ” Yes | Requires Flex delegate or newer interpreter |

TinyMLDelta rejects incompatible patches automatically.

------------------------------------------------------------------------

## Architecture Overview

PatchGen (PC/CI) runs off-target and is **stateless**.
TinyMLDelta Core enforces all safety on-device.

### PatchGen (PC/CI)

-   Loads the base & target models
-   Computes byte-level differences
-   Merges and compresses diff chunks
-   Calculates integrity digests
-   Extracts metadata (arena, ABI, opset hash, I/O hash)
-   Assembles everything into a `.tmd` patch

### TinyMLDelta Core (MCU)

-   Parses the patch header & TLVs
-   Verifies compatibility guardrails
-   Copies active â†’ inactive slot
-   Applies diff chunks to the inactive slot
-   Verifies CRCs / digests
-   Atomically flips the active slot

### High-Level Data Flow

              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Base Model (flash)     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ read
                         â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚ Patch Generator (PC)   â”‚
               â”‚  â€¢ diff engine         â”‚
               â”‚  â€¢ metadata TLVs       â”‚
               â”‚  â€¢ integrity checks    â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ OTA send
                         â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚ TinyMLDelta Core (MCU) â”‚
               â”‚  â€¢ copy activeâ†’inactiveâ”‚
               â”‚  â€¢ apply diff chunks   â”‚
               â”‚  â€¢ verify CRC/digests  â”‚
               â”‚  â€¢ enforce guardrails  â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”˜
                         â”‚ atomically flip
                         â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚ Target Model (flash)   â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

The MCU **never** receives a full model --- only a delta.

------------------------------------------------------------------------

## Wire Format

### Patch Header (`tmd_hdr_t`)

``` c
typedef struct __attribute__((packed)) {
  uint8_t  v;
  uint8_t  algo;
  uint16_t chunks_n;
  uint32_t base_len;
  uint32_t target_len;
  uint8_t  base_chk[32];
  uint8_t  target_chk[32];
  uint16_t meta_len;
  uint16_t flags;
} tmd_hdr_t;
```

### Metadata TLVs

Each TLV is encoded as:

    [tag][len][value...]

Current TLVs:

-   `REQ_ARENA_BYTES` (u32)
-   `TFLM_ABI` (u16)
-   `OPSET_HASH` (u32)
-   `IO_HASH` (u32)

Planned TLVs:

-   Model version, model family/architecture
-   Certificate + signature blocks
-   Dataset lineage
-   Firmware feature flags
-   Strict/relaxed validation modes

### Chunk Header (`tmd_chunk_hdr_t`)

``` c
typedef struct __attribute__((packed)) {
  uint32_t off;
  uint16_t len;
  uint8_t  enc;      // 0 = RAW, 1 = RLE
  uint8_t  has_crc;
} tmd_chunk_hdr_t;
```

------------------------------------------------------------------------

## Installation (CLI)

``` bash
cd cli/
./install.sh
source .tinyenv/bin/activate
```

Installer output example:

    === TinyMLDelta CLI Installer ===
    Creating virtual environment .tinyenv ...
    Installing TinyMLDelta CLI requirements...
    ...
    TinyMLDelta CLI environment is ready!

------------------------------------------------------------------------

## Quickstart: Run the POSIX Demo

The POSIX demo simulates a full MCU update flow end-to-end:
model generation â†’ patch generation â†’ flash creation â†’ patch apply â†’
verification.

A **full standalone walkthrough** (with complete logs, explanations, and
verification steps) is here:

ğŸ‘‰ **`examples/posix/Quickstart.md`**

To run the demo:

``` bash
cd cli
./install.sh
source .tinyenv/bin/activate

cd ../examples/posix
./run_demo.sh
```

------------------------------------------------------------------------

### Demo Results

-   **Base model:** 66,368 bytes
-   **Target model:** 66,368 bytes
-   **Patch file:** 474 bytes total
-   **Encoded diff data:** 382 bytes
-   **Single diff chunk:** offset 62,728, length 382 bytes
-   **Flash slots:** 131,072 bytes each (A/B)

**Result:** patch applied successfully and flash matches the target
model exactly.

------------------------------------------------------------------------

## Directory Layout

```text
TinyMLDelta/
â”œâ”€â”€ cli/
â”‚   â”œâ”€â”€ install.sh                 # Optional: create a local venv + install CLI deps
â”‚   â”œâ”€â”€ requirements.txt           # Python deps for PatchGen + demo tooling
â”‚   â”œâ”€â”€ tinymldelta_patchgen.py    # PatchGen: build .tmd patches from base/target models
â”‚   â””â”€â”€ tinymldelta_meta_compute.py# (optional) TFLite-aware metadata helper (future use)
â”‚
â”œâ”€â”€ examples/
â”‚   â”œâ”€â”€ modelgen/
â”‚   â”‚   â”œâ”€â”€ make_models.py         # Generates small TFLite sensor models for the demo
â”‚   â”‚   â”œâ”€â”€ README.md              # Notes on model generation / usage
â”‚   â”‚   â””â”€â”€ (base.tflite, target.tflite are generated artifacts)
â”‚   â”‚
â”‚   â””â”€â”€ posix/
â”‚       â”œâ”€â”€ Makefile               # Builds demo_apply using POSIX ports + core
â”‚       â”œâ”€â”€ run_demo.sh            # End-to-end demo: generate models â†’ patch â†’ apply â†’ verify
â”‚       â”œâ”€â”€ make_flash.py          # Creates flash.bin with A/B slots + journal region
â”‚       â”œâ”€â”€ flash_layout.h         # Simulated flash layout (tmd_layout_t) for the demo
â”‚       â”œâ”€â”€ demo_apply.c           # TinyMLDelta POSIX sample app (patch applier)
â”‚       â”œâ”€â”€ tinymldelta_ports_posix.c # POSIX implementation of tmd_ports_t (flash/journal/log)
â”‚       â”œâ”€â”€ verify_flash.py        # Verifies flash.bin contains the exact target.tflite bytes
â”‚       â””â”€â”€ (flash.bin, patch.tmd, *.o, demo_apply are build/generated artifacts)
â”‚
â”œâ”€â”€ runtime/
â”‚   â”œâ”€â”€ include/
â”‚   â”‚   â”œâ”€â”€ tinymldelta.h          # Public C API for TinyMLDelta core
â”‚   â”‚   â”œâ”€â”€ tinymldelta_config.h   # Build-time feature flags + firmware guardrail config
â”‚   â”‚   â”œâ”€â”€ tinymldelta_internal.h # On-wire header / TLV / chunk structures
â”‚   â”‚   â””â”€â”€ tinymldelta_ports.h    # Platform abstraction: flash, digests, slots, journal, log
â”‚   â””â”€â”€ src/
â”‚       â””â”€â”€ tinymldelta_core.c     # Platform-agnostic patch application engine
â”‚
â”œâ”€â”€ LICENSE                        # Apache-2.0 license
â”œâ”€â”€ SECURITY.md                    # Security contact / disclosure policy
â””â”€â”€ README.md                      # Project overview and usage
```
------------------------------------------------------------------------

## Contributing

Contributions welcome:

- New front-ends (Edge Impulse)  
- Optimized diff algorithms  
- Additional MCU ports (Zephyr, Arduino, STM32, ESP32)  
- Metadata TLV extensions  
- Docs improvements  
- Security signing pipeline  

------------------------------------------------------------------------

## License

Apache-2.0\
Â© 2024--2025 TinyMLDelta Project / Felix Galindo